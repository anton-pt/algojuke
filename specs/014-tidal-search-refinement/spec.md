# Feature Specification: Tidal Search Tool Refinement

**Feature Branch**: `014-tidal-search-refinement`
**Created**: 2025-01-02
**Status**: Draft
**Input**: User description: "Refinements to the Tidal search tool introduced in @specs/011-agent-tools/spec.md to make it clear to the agent that it does not support semantic search - only search by artist, album, or track name. The agent should rely on its own knowledge of relevant artists and albums to surface relevant recommendations that are part of the Tidal catalogue but not necessarily in the user's library. For semantic search, the agent should use the semantic search tool only, but this will only retrieve indexed tracks, and not ones that are part of the broader Tidal catalogue."

## Clarifications

### Session 2025-01-02

- Q: Should the agent only augment semantic search with Tidal when few results are returned? → A: No, semantic search always returns results (RRF hybrid search has no obvious score cutoff), so the agent should ALWAYS augment semantic search with one or more Tidal searches based on its music knowledge.
- Q: What does semantic search match against? → A: Semantic search uses embedding vectors and BM25 keyword search on the **lyrics interpretation** generated by the ingestion pipeline. It matches thematic/lyrical content, NOT musical style or audio characteristics. For style-based recommendations (e.g., "ambient music", "jazz"), the agent must rely on its own music knowledge.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Agent Uses Knowledge-Driven Discovery (Priority: P1)

As a music enthusiast asking for mood-based recommendations, I want the AI agent to intelligently combine semantic search of my library with its own music knowledge to suggest relevant artists and albums from the Tidal catalogue, so that I can discover new music that fits my mood even when my indexed library lacks matching tracks.

**Why this priority**: This is the core value proposition - the agent should leverage its knowledge of music to bridge the gap between the user's indexed library (semantic search) and the broader Tidal catalogue (text search). Without this, users who ask for mood-based recommendations would only receive results from their indexed tracks, missing discovery opportunities.

**Independent Test**: Can be fully tested by asking the agent "Find me some melancholic indie folk music" when the user's indexed library has no matching tracks, and verifying the agent uses its knowledge to search Tidal for relevant artists/albums (e.g., Bon Iver, Sufjan Stevens, Fleet Foxes).

**Acceptance Scenarios**:

1. **Given** I ask for "uplifting jazz for a Sunday morning", **When** the agent processes my request, **Then** the agent uses semantic search for my library AND uses its music knowledge to search Tidal for relevant jazz artists and albums
2. **Given** the agent completes semantic search for a mood query, **When** it proceeds to search Tidal, **Then** it formulates specific artist, album, or track name queries rather than mood-based queries
3. **Given** the agent searches Tidal using artist names it knows, **When** results are returned, **Then** the agent explains why it suggested those artists based on the user's original mood/theme request
4. **Given** I describe a complex emotional state, **When** the agent processes my request, **Then** it translates that into knowledge of relevant genres, artists, and albums to search Tidal

---

### User Story 2 - Clear Tool Selection Guidance (Priority: P1)

As an AI agent serving a music discovery chat, I need clear guidance on when to use semantic search versus Tidal catalogue search, so that I use the appropriate tool for each type of query and provide users with the best possible results.

**Why this priority**: Equally critical as the agent must correctly understand tool capabilities to function effectively. Incorrect tool selection leads to poor results and confused users.

**Independent Test**: Can be fully tested by observing agent behavior across different query types: mood queries should trigger semantic search first, while artist/album/track name queries should trigger Tidal search directly.

**Acceptance Scenarios**:

1. **Given** a user asks "play something by Radiohead", **When** the agent processes this request, **Then** it uses Tidal search directly since this is an artist-name query
2. **Given** a user asks "find me energetic workout music", **When** the agent processes this request, **Then** it uses semantic search for the indexed library AND formulates Tidal searches based on its music knowledge
3. **Given** the agent completes semantic search for a mood query, **When** it formulates Tidal queries, **Then** it uses specific artist/album names from its knowledge (not mood text)
4. **Given** a user asks "what albums does The National have", **When** the agent processes this request, **Then** it uses Tidal search directly without attempting semantic search
5. **Given** the agent tool descriptions are presented, **When** the agent reads the Tidal search tool description, **Then** it clearly understands the tool only supports text-based search by artist, album, or track name

---

### User Story 3 - Transparent Search Strategy Communication (Priority: P2)

As a music enthusiast, I want to understand why the agent chose certain artists or albums when expanding beyond my library, so that I trust the recommendations and learn about connections between my preferences and new discoveries.

**Why this priority**: Builds user trust and engagement. While the system works without this, explaining the reasoning improves user experience and helps users understand the agent's music knowledge.

**Independent Test**: Can be fully tested by asking for a mood-based request, receiving Tidal catalogue recommendations, and verifying the agent explains the connection (e.g., "Based on your interest in melancholic themes, I searched for Bon Iver who is known for introspective, atmospheric folk music").

**Acceptance Scenarios**:

1. **Given** the agent searches Tidal for artists based on my mood request, **When** it presents results, **Then** it explains the reasoning (e.g., "Since you asked for dreamy shoegaze, I looked up Cocteau Twins and My Bloody Valentine")
2. **Given** the agent combines semantic library results with Tidal discoveries, **When** presenting the combined list, **Then** it clearly distinguishes which came from the library versus Tidal
3. **Given** the agent uses its music knowledge to expand search, **When** it presents artists it searched for, **Then** it acknowledges it's using general music knowledge rather than user-specific data

---

### User Story 4 - Handling Semantic Queries with Empty Library Results (Priority: P2)

As a new user with few indexed tracks, I want the agent to still provide valuable mood-based recommendations by leveraging the Tidal catalogue, so that I'm not limited by my small indexed library.

**Why this priority**: Addresses a key user segment (new users) who would otherwise have a poor experience. The agent's value should not be gated on library size.

**Independent Test**: Can be fully tested by a user with an empty indexed library asking for "relaxing ambient music" and receiving Tidal-based recommendations with clear explanation.

**Acceptance Scenarios**:

1. **Given** my indexed library is empty, **When** I ask for mood-based music, **Then** the agent acknowledges it cannot find semantic matches in my library and proactively offers Tidal catalogue suggestions
2. **Given** semantic search returns zero results, **When** the agent switches to Tidal search, **Then** it informs the user that it's searching the broader catalogue using its music knowledge
3. **Given** the agent cannot find any relevant music in Tidal either, **When** it reports this to the user, **Then** it suggests the user try different search terms or describe their preferences differently

---

### Edge Cases

- What happens when the agent misidentifies a mood query as an artist query (e.g., "play some Low" where Low is a band)? The agent should attempt Tidal search first for proper nouns and artist-like terms, then fall back to semantic search if no results.
- What happens when the user's mood description is too vague for the agent to map to specific artists? The agent should ask clarifying questions about genre preferences or example artists the user already likes.
- What happens when the agent's music knowledge is outdated (new artists released after training cutoff)? The agent should acknowledge it may not know the newest artists and suggest the user search by artist name directly if they have specific new artists in mind.
- What happens when Tidal search returns no results for artists the agent suggests? The agent should try alternative artists in the same genre/mood category and inform the user some suggested artists may not be available on Tidal.
- What happens when semantic search and Tidal search return conflicting relevance signals? The agent should present results from both sources clearly labeled, allowing the user to choose.

## Requirements *(mandatory)*

### Functional Requirements

#### Tool Description Clarity

- **FR-001**: The Tidal search tool description MUST explicitly state it only supports text-based search by artist name, album name, or track name
- **FR-002**: The Tidal search tool description MUST explicitly state it does not support semantic or mood-based queries
- **FR-003**: The semantic search tool description MUST explicitly state it searches only the user's indexed library based on lyrics interpretation, not musical style or the broader Tidal catalogue
- **FR-004**: Tool descriptions MUST provide guidance on when to use each tool based on query type

#### Agent Behavior for Mood-Based Queries

- **FR-005**: When processing mood-based requests, the agent MUST perform semantic search of the indexed library
- **FR-006**: For mood-based requests, the agent MUST ALWAYS augment semantic search results with one or more Tidal searches using artist/album names derived from its music knowledge (semantic search always returns results due to RRF hybrid scoring, so relevance cannot be determined by result count)
- **FR-007**: The agent MUST translate mood/theme descriptions into specific artist, album, or genre knowledge when constructing Tidal queries
- **FR-008**: The agent MUST NOT pass mood-based query text directly to the Tidal search tool

#### Agent Behavior for Direct Queries

- **FR-009**: When the user specifies an artist, album, or track name, the agent MUST use Tidal search directly
- **FR-010**: The agent MUST recognize artist names, album titles, and track names as direct query candidates for Tidal search

#### Response Transparency

- **FR-011**: When the agent uses its music knowledge to expand search beyond the library, it MUST explain its reasoning to the user
- **FR-012**: Results from semantic search (indexed library) and Tidal catalogue search MUST be clearly distinguished in agent responses
- **FR-013**: The agent MUST inform users when switching from semantic library search to Tidal catalogue search

#### Error Handling

- **FR-014**: When both semantic search and Tidal search return no relevant results, the agent MUST provide helpful guidance for reformulating the query
- **FR-015**: When the agent's suggested artists are not available on Tidal, it MUST gracefully fall back to alternative suggestions

### Key Entities

- **Query Type**: Classification of user input as either "mood-based" (semantic search candidate) or "name-based" (Tidal search candidate). Attributes include query text, detected type, and confidence level.
- **Search Strategy**: The agent's planned approach for fulfilling a user request. May include sequential tool usage (semantic first, then Tidal) or direct tool selection based on query type.
- **Knowledge-Derived Query**: A Tidal search query formulated by the agent based on its music knowledge rather than user input. Includes the original mood/theme, the derived artist/album names, and the reasoning connection.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Agent correctly classifies 95% of user queries as mood-based or name-based
- **SC-002**: For mood-based queries, agent ALWAYS performs both semantic search AND at least one Tidal search using music knowledge (100% compliance)
- **SC-003**: Agent never passes raw mood/theme text to Tidal search tool (100% compliance)
- **SC-004**: Users understand which results came from their library versus Tidal catalogue (verified by clear labeling in 100% of mixed-source responses)
- **SC-005**: Agent provides reasoning for artist/album suggestions in 100% of knowledge-derived Tidal searches
- **SC-006**: Agent correctly routes direct artist/album/track name queries to Tidal search without attempting semantic search first (95% accuracy)
- **SC-007**: Users with empty indexed libraries receive meaningful Tidal-based recommendations for mood queries (100% of such requests receive at least 3 suggestions)

## Assumptions

- The agent has sufficient music knowledge to map mood/theme descriptions to relevant artists, albums, and genres
- The agent can distinguish between mood-based language ("melancholic", "uplifting", "energetic") and proper nouns/artist names
- The existing Tidal search tool returns useful results when queried with specific artist, album, or track names
- The semantic search tool matches tracks based on lyrics interpretation embeddings and BM25 keyword search, NOT musical style or audio features
- Semantic search always returns results due to RRF hybrid scoring; result count is not a reliable indicator of relevance
- Users understand the difference between their personal indexed library and the broader Tidal catalogue
- Success criteria percentages (SC-001, SC-006) are verified through representative manual testing during development (20+ queries per category), not automated runtime measurement

## Dependencies

- **specs/011-agent-tools**: Provides the existing Tidal search and semantic search tools that this feature refines
- **specs/010-discover-chat**: Provides the chat agent framework and streaming infrastructure

## Scope Boundaries

### In Scope

- Updating Tidal search tool description to clarify text-only search capability
- Updating semantic search tool description to clarify library-only scope
- Defining agent behavior guidelines for query classification and tool selection
- Specifying transparency requirements for mixed-source results
- Defining graceful fallback behavior when searches return insufficient results

### Out of Scope

- Modifying the underlying Tidal API search mechanism
- Adding semantic search capability to Tidal catalogue (would require embedding the entire catalogue)
- Training or fine-tuning the agent's music knowledge
- Adding user preference learning or personalization
- Playlist creation or persistence
- Audio playback functionality
