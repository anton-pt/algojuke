# Implementation Plan: Agent Tool Optimization

**Branch**: `013-agent-tool-optimization` | **Date**: 2026-01-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/013-agent-tool-optimization/spec.md`

## Summary

Optimize agent semantic search tool to reduce token usage by returning `short_description` instead of full `interpretation` and `lyrics`. The Qdrant query will use field selection (`with_payload` array) to request only the fields needed, reducing network transfer. The batch metadata tool will continue returning full metadata for on-demand deep inspection. The Discover UI search (feature 009) is unaffected.

## Technical Context

**Language/Version**: TypeScript 5.3.3 / Node.js 20.x
**Primary Dependencies**: @qdrant/js-client-rest (Qdrant client), Vercel AI SDK (agent), Zod (validation)
**Storage**: Qdrant vector database (already contains `short_description` field from feature 012)
**Testing**: Vitest 1.x
**Target Platform**: Linux server (Docker)
**Project Type**: Web application (backend + frontend)
**Performance Goals**: 70%+ payload reduction in semantic search results
**Constraints**: Maintain compatibility with Discover UI search (feature 009)
**Scale/Scope**: Affects agent tool layer only; ~4 files to modify

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Test-First Development | ✅ PASS | Contract tests for new response schemas; integration tests for field selection |
| II. Code Quality Standards | ✅ PASS | Simple change to existing tools; no new abstractions needed |
| III. User Experience Consistency | ✅ PASS | Agent UX unchanged; Discover UI unaffected |
| IV. Robust Architecture | ✅ PASS | Clean separation: agent tools vs UI service |
| V. Security by Design | ✅ PASS | No new security surface; data filtering only |

**No violations requiring justification.**

## Project Structure

### Documentation (this feature)

```text
specs/013-agent-tool-optimization/
├── plan.md              # This file
├── research.md          # Qdrant field selection research
├── data-model.md        # Updated tool output types
├── quickstart.md        # Testing guide
├── contracts/           # Updated tool schemas
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── clients/
│   │   └── qdrantClient.ts         # Add hybridSearchOptimized method
│   ├── services/
│   │   ├── agentTools/
│   │   │   ├── semanticSearchTool.ts  # Use optimized search, return short_description
│   │   │   └── batchMetadataTool.ts   # Ensure full metadata returned
│   │   ├── discoveryService.ts     # UNCHANGED (Discover UI uses this)
│   │   └── trackMetadataService.ts # UNCHANGED
│   └── types/
│       └── agentTools.ts           # Add OptimizedIndexedTrackResult type
└── tests/
    ├── contract/
    │   └── agentTools/
    │       └── optimizedSearch.test.ts  # New: validate optimized output
    └── integration/
        └── agentTools/
            └── semanticSearchOptimized.test.ts  # New: E2E with Qdrant
```

**Structure Decision**: Using existing web application structure. Changes are localized to `backend/src/services/agentTools/` and `backend/src/clients/qdrantClient.ts`. The Discover UI feature (009) uses `discoveryService.ts` which remains unchanged.

## Complexity Tracking

No violations to justify. This is a straightforward optimization with minimal changes.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│ AGENT TOOL PATH (optimized in this feature)                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Chat Agent                                                              │
│       │                                                                  │
│       ▼                                                                  │
│  semanticSearchTool.ts ──► hybridSearchOptimized() ──► Qdrant           │
│       │                    with_payload: [                               │
│       │                      "isrc", "title", "artist", "album",        │
│       │                      "short_description", "acousticness", ...   │
│       │                    ]                                             │
│       │                    (excludes: interpretation, lyrics)            │
│       │                                                                  │
│       ▼                                                                  │
│  OptimizedIndexedTrackResult                                            │
│    - short_description: string | null                                   │
│    - NO interpretation                                                   │
│    - NO lyrics                                                           │
│                                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│ BATCH METADATA PATH (unchanged - returns full data)                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Chat Agent                                                              │
│       │                                                                  │
│       ▼                                                                  │
│  batchMetadataTool.ts ──► getTrackPayload() ──► Qdrant                  │
│       │                   with_payload: true                             │
│       │                   (returns ALL fields)                           │
│       │                                                                  │
│       ▼                                                                  │
│  IndexedTrackResult (unchanged)                                         │
│    - interpretation: string | null                                      │
│    - lyrics: string | null                                              │
│    - short_description: string | null                                   │
│                                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│ DISCOVER UI PATH (UNAFFECTED)                                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Discover Page                                                           │
│       │                                                                  │
│       ▼                                                                  │
│  discoveryService.ts ──► hybridSearch() ──► Qdrant                      │
│       │                  with_payload: true                              │
│       │                  (unchanged, returns all fields)                 │
│       │                                                                  │
│       ▼                                                                  │
│  DiscoveryResult + trackMetadataService.getExtendedMetadata()           │
│    - Full interpretation displayed in accordion                         │
│    - Full lyrics displayed in accordion                                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Key Design Decisions

1. **New Method vs Modifying Existing**: Add `hybridSearchOptimized()` method rather than modifying `hybridSearch()` to maintain backward compatibility with Discover UI.

2. **Field Selection in Qdrant**: Use `with_payload: ["field1", "field2", ...]` syntax to request only needed fields at the network level, reducing bytes transferred.

3. **New Type for Optimized Results**: Create `OptimizedIndexedTrackResult` type that has `short_description` instead of `interpretation`/`lyrics` to provide compile-time safety.

4. **Batch Metadata Unchanged**: The batch metadata tool already fetches full payload; ensure it continues to return `interpretation` and `lyrics` for on-demand deep inspection.

5. **Agent System Prompt Update**: Add guidance to the agent about the two-tier approach: use short descriptions for scanning, fetch full metadata sparingly.
